# AI会話練習機能 - 実装ガイド

## 概要

このドキュメントでは、SOZO AppのAI会話練習機能の新しい実装について説明します。

## 新機能

### 1. OpenAI Whisper音声認識

従来のAzure Speech Servicesに代わり、OpenAI Whisperを使用した音声認識を実装しました。

**メリット:**
- より高精度な音声認識
- 多言語対応
- ノイズ環境でも安定した認識

**使用方法:**
```dart
final whisperService = WhisperService();
final transcription = await whisperService.transcribeAudio(
  audioFile: File(audioPath),
  language: 'en', // 英語を指定
);
```

### 2. リアルタイムフィードバック

ChatGPT-4o-miniがユーザーの発言を分析し、以下のフィードバックを提供します：

- **文法エラーチェック**: 文法的な誤りを検出し、正しい表現を提案
- **的外れ判定**: 会話の文脈から外れた発言を検出
- **重要度レベル**: none（問題なし）、minor（軽微）、major（重大）

**フィードバックの表示:**
- メッセージの色で重要度を表現
  - 青: 問題なし
  - オレンジ: 軽微な問題
  - 赤: 重大な問題

### 3. 詳細フィードバック機能

各メッセージの「フィードバック」ボタンをタップすると、以下の詳細情報が表示されます：

- **文法スコア**: 0-100点で文法の正確性を評価
- **流暢さスコア**: 自然な英語表現の度合い
- **関連性スコア**: 会話の文脈との関連性
- **文法エラーの詳細**: 各エラーの説明と修正案
- **発音のヒント**: より良い発音のためのアドバイス
- **語彙フィードバック**: 使用した良い表現と改善提案

### 4. メッセージ取り消し機能

誤って送信したメッセージを取り消すことができます：

- 最新のユーザーメッセージに「取り消し」ボタンが表示
- 取り消すと、そのメッセージとAIの応答が削除
- やり直して新しいメッセージを送信可能

### 5. 翻訳機能

AI応答の日本語翻訳を表示できます：

- 画面上部の翻訳アイコンをタップして表示/非表示を切り替え
- AIの応答の下に薄いグレーの背景で翻訳を表示
- 理解が難しい部分をすぐに確認可能

## 技術仕様

### AIプロンプト設計

システムプロンプトでJSON形式の応答を要求：

```json
{
  "response": "会話の応答",
  "feedback": {
    "grammar_errors": ["エラー1", "エラー2"],
    "suggestions": ["提案1", "提案2"],
    "is_off_topic": false,
    "severity": "none"
  },
  "translation": "日本語訳"
}
```

### エラーハンドリング

- 音声認識失敗時: エラーメッセージを表示し、再試行を促す
- AI応答エラー時: フォールバック応答を使用
- ネットワークエラー時: オフライン通知を表示

## 設定要件

### 必要なAPIキー

`.env`ファイルに以下を設定：

```env
OPENAI_API_KEY=your_openai_api_key_here
```

### 料金について

- Whisper API: $0.006 / 分
- ChatGPT-4o-mini: $0.15 / 1M入力トークン、$0.6 / 1M出力トークン
- TTS (nova voice): $15 / 1M文字

## 使用フロー

1. **録音開始**: マイクボタンをタップ
2. **話す**: 英語で話す（録音時間が表示）
3. **停止**: 停止ボタンをタップ
4. **処理**: Whisperが音声を認識し、ChatGPTが応答を生成
5. **フィードバック確認**: メッセージの色とアイコンで即座に確認
6. **詳細確認**: 必要に応じてフィードバックボタンで詳細を表示
7. **修正**: 必要なら取り消して再度話す

## トラブルシューティング

### 音声が認識されない

- マイクの権限を確認
- 静かな環境で話す
- はっきりと発音する

### フィードバックが表示されない

- インターネット接続を確認
- OpenAI APIキーが正しく設定されているか確認

### 翻訳が不自然

- AIモデルの制限により、完璧な翻訳は期待できません
- 大まかな意味の理解に使用してください 