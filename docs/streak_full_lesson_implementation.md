# ストリーク機能実装変更：レッスン全完了時のみ更新

## 変更概要
レッスンの**すべてのアクティビティ（6つ）が完了した時のみ**ストリークが更新されるように変更しました。

## 変更前後の比較

### 変更前の動作
- 各アクティビティ完了時にストリーク更新
- 例：語彙練習だけ完了 → ストリーク+1

### 変更後の動作
- 6つすべてのアクティビティにチェックマークが付いた時のみストリーク更新
- 部分的な完了ではストリークは増えない

## アクティビティ一覧と完了フラグ

| # | アクティビティ | データベースカラム | アイコン |
|---|------------|---------------|--------|
| 1 | 語彙練習 | vocabulary_completed | 📚 |
| 2 | キーフレーズ練習 | key_phrase_completed | 🗣️ |
| 3 | リスニング練習 | listening_completed | 👂 |
| 4 | ダイアログ練習 | dialog_completed | 💬 |
| 5 | 応用練習 | application_completed | 🎯 |
| 6 | AI会話練習 | ai_conversation_completed | 🤖 |

## 技術的な実装詳細

### ProgressService.dart の変更点

```dart
// completeActivity メソッドの変更箇所（59-174行目）

1. 各アクティビティ完了時にフラグを更新
   - vocabulary_completed = true など

2. 全アクティビティの完了チェック
   const isLessonCompleted =
     vocabulary_completed &&
     key_phrase_completed &&
     listening_completed &&
     dialog_completed &&
     application_completed &&
     ai_conversation_completed;

3. 条件分岐
   if (isLessonCompleted) {
     // レッスン完了！ストリーク更新
     await complete_lesson();  // ストリーク更新あり
   } else {
     // まだ未完了アクティビティあり
     await add_user_xp();      // XPのみ付与
   }
```

### データベースの処理フロー

```sql
アクティビティ完了
↓
user_lesson_progress テーブル更新
  └─ 該当するcompleted フラグをtrue に
↓
全6つのフラグをチェック
↓
すべてtrue の場合のみ
  └─ complete_lesson() 関数を呼び出し
      └─ ストリーク更新
      └─ learning_sessions 記録
      └─ XP・レベル更新
```

## ユーザー体験の変化

### 画面での見え方

**レッスン画面のステップ表示:**
```
┌─────────────────────────────────┐
│ レッスン: 美容院での会話          │
├─────────────────────────────────┤
│ ✅ 語彙練習                      │
│ ✅ キーフレーズ練習               │
│ ✅ リスニング練習                 │
│ ✅ ダイアログ練習                │
│ ⬜ 応用練習 ← まだ未完了          │
│ ⬜ AI会話練習 ← まだ未完了        │
└─────────────────────────────────┘
この状態ではストリークは増えない
```

**全完了時:**
```
┌─────────────────────────────────┐
│ レッスン: 美容院での会話          │
├─────────────────────────────────┤
│ ✅ 語彙練習                      │
│ ✅ キーフレーズ練習               │
│ ✅ リスニング練習                 │
│ ✅ ダイアログ練習                │
│ ✅ 応用練習                      │
│ ✅ AI会話練習                    │
└─────────────────────────────────┘
🎉 レッスン完了！ストリーク更新！
```

## 実際の挙動例

### シナリオ1: 部分的な完了
```
月曜日：
10:00 - 語彙練習完了 → XP+80、ストリーク変化なし
11:00 - キーフレーズ完了 → XP+80、ストリーク変化なし
（この日はここで終了）
→ ストリーク: 0のまま
```

### シナリオ2: 全アクティビティ完了
```
火曜日：
10:00 - 語彙練習完了 → XP+80
10:30 - キーフレーズ完了 → XP+80
11:00 - リスニング完了 → XP+100
14:00 - ダイアログ完了 → XP+120
15:00 - 応用練習完了 → XP+100
16:00 - AI会話完了 → XP+150
→ ストリーク: 0 → 1 に更新！
```

### シナリオ3: 複数日にまたがる場合
```
水曜日：
- 語彙、キーフレーズ、リスニング完了
→ ストリーク: 1のまま（未完了）

木曜日：
- ダイアログ、応用、AI会話完了
→ レッスン全体完了！
→ ストリーク: 1 → 2 に更新！
```

## テスト方法

### SQLでのテスト
```sql
-- test_full_lesson_completion.sql を実行
-- 各アクティビティを順番に完了させて
-- 最後のアクティビティ完了時のみストリークが更新されることを確認
```

### アプリでのテスト手順
1. 新しいレッスンを開始
2. 語彙練習を完了 → 進捗画面でストリーク確認（変化なし）
3. 他の5つのアクティビティも順番に完了
4. 最後（AI会話）完了時 → ストリークが+1される

## 注意事項

- **中断したレッスンの扱い**:
  - 進捗は保存される
  - 後日続きから再開可能
  - すべて完了した時点でストリーク更新

- **同じレッスンを複数回完了**:
  - 同日なら1回目のみストリークカウント
  - 別日なら再度ストリーク更新可能

- **XPは常に獲得**:
  - 各アクティビティ完了でXP獲得
  - ストリークとは独立して処理

## 今後の検討事項
- [ ] 部分完了でも小さなボーナス（ストリークではない別の指標）
- [ ] レッスン途中セーブの可視化
- [ ] 「あと○個でレッスン完了」の表示