<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI英会話レッスン</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .lesson-card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .response-area {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        #nextStepButton {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5">AI英会話レッスン</h1>
        <div id="lessonStartArea">
            <div class="row">
                {% for lesson in lessons %}
                <div class="col-md-6">
                    <div class="card lesson-card">
                        <div class="card-body">
                            <h5 class="card-title">{{ lesson.title }}</h5>
                            <button class="btn btn-primary" onclick="startLesson('{{ lesson.id }}')">レッスンを開始</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not lessons %}
                <div class="col-md-12">
                    <div class="alert alert-warning">
                        <p>現在、利用可能なレッスンがありません。</p>
                        <p>レッスンコンテンツが正しく読み込まれていることを確認してください。</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="response-area mt-4" id="responseArea" style="display:none;"></div>
        <div id="inputArea" class="mt-3" style="display:none;">
            <form id="lessonForm" onsubmit="sendUserInput(event)">
                <div class="input-group">
                    <input type="text" class="form-control" id="userInput" placeholder="あなたの回答を入力..." autocomplete="off" required>
                    <button class="btn btn-success" type="submit">送信</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lessonId = null;
        
        // APIステータスを確認
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                if (!data.openai_api) {
                    document.getElementById('lessonStartArea').innerHTML += `
                        <div class="alert alert-warning mt-3">
                            <strong>注意:</strong> OpenAI APIキーが設定されていません。モックモードで動作します。
                        </div>
                    `;
                }
                
                if (!data.lessons_loaded) {
                    document.getElementById('lessonStartArea').innerHTML += `
                        <div class="alert alert-danger mt-3">
                            <strong>エラー:</strong> レッスンデータの読み込みに失敗しました。
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('APIステータス確認中にエラーが発生しました:', error);
            });
        
        function startLesson(id) {
            document.getElementById('responseArea').style.display = 'block';
            document.getElementById('responseArea').innerHTML = '<p class="text-center">レッスンを開始しています...</p>';
            
            fetch('/api/lesson/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lesson_id: id})
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('responseArea').innerHTML = `<p class="text-danger">エラー: ${data.error}</p>`;
                    return;
                }
                
                lessonId = data.lesson_id;
                document.getElementById('lessonStartArea').style.display = 'none';
                document.getElementById('inputArea').style.display = 'block';
                document.getElementById('responseArea').innerHTML = `<p>${data.prompt || 'レッスンを開始します。'}</p>`;
                
                if (data.is_complete) {
                    document.getElementById('responseArea').innerHTML += '<p>レッスンは完了しています。</p>';
                    document.getElementById('inputArea').style.display = 'none';
                }
            })
            .catch(error => {
                document.getElementById('responseArea').innerHTML = `<p class="text-danger">エラー: レッスンの開始に失敗しました。${error}</p>`;
            });
        }

        function sendUserInput(event) {
            event.preventDefault();
            const userInput = document.getElementById('userInput').value;
            if (userInput.trim() === '') return; // 空の入力は無視
            document.getElementById('userInput').value = '';
            document.getElementById('responseArea').innerHTML += `<hr><b>あなた:</b> ${userInput}`;
            document.getElementById('responseArea').scrollTop = document.getElementById('responseArea').scrollHeight;
            
            document.querySelector('#lessonForm button').disabled = true;
            
            fetch('/api/lesson/next', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({response: userInput})
            })
            .then(res => res.json())
            .then(data => {
                document.querySelector('#lessonForm button').disabled = false;
                if (data.error) {
                    document.getElementById('responseArea').innerHTML += `<br><span class='text-danger'>エラー: ${data.error}</span>`;
                    return;
                }
                
                document.getElementById('responseArea').innerHTML += `<br><b>AI:</b> ${data.ai_response}`;
                
                if (data.next_prompt) {
                    document.getElementById('responseArea').innerHTML += `<hr><p>${data.next_prompt}</p>`;
                }
                
                if (data.is_complete) {
                    document.getElementById('responseArea').innerHTML += `<hr><b>レッスン終了です。お疲れ様でした！</b>`;
                    document.getElementById('inputArea').style.display = 'none';
                }
                
                document.getElementById('responseArea').scrollTop = document.getElementById('responseArea').scrollHeight;
            })
            .catch(error => {
                document.querySelector('#lessonForm button').disabled = false;
                document.getElementById('responseArea').innerHTML += `<br><span class='text-danger'>エラーが発生しました: ${error}</span>`;
            });
        }
    </script>
</body>
</html> 